<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move It OKR Master</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #2563eb; --bg: #f1f5f9; --txt: #0f172a; }
        body { font-family: sans-serif; background: var(--bg); color: var(--txt); margin: 0; padding-bottom: 50px; }
        nav { background: #1e293b; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { background: var(--p); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn:disabled { background: #94a3b8; }
        .hidden { display: none; }
        .okr-item { border-left: 5px solid var(--p); padding-left: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .legal-link { font-size: 0.8rem; color: #64748b; text-decoration: none; margin-right: 10px; }
    </style>
</head>
<body>

<nav>
    <strong>ðŸš€ Move It</strong>
    <a href="index.html">Mis Objetivos</a>
    <a href="tools/checklist/index.html">Checklist Report</a>
    
    <div id="nav-user" class="hidden">
        <button onclick="logout()" style="background:none; border:1px solid white; color:white; cursor:pointer; border-radius:4px;">Salir</button>
    </div>
    
</nav>

<div class="container">
    <section id="auth-section" class="card">
        <h2 id="auth-title">Iniciar SesiÃ³n</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="ContraseÃ±a">
        <button id="btn-auth" class="btn" onclick="handleAuth()">Entrar</button>
        <p style="text-align:center">
            <a href="javascript:void(0)" onclick="toggleAuth()" id="toggle-text">Â¿No tienes cuenta? RegÃ­strate</a>
        </p>
        <p style="text-align:center"><a href="javascript:void(0)" onclick="resetPass()" style="font-size:0.8rem">OlvidÃ© mi contraseÃ±a</a></p>
    </section>

    <section id="app-section" class="hidden">
        <div class="card">
            <h3>+ Nuevo Objetivo Anual</h3>
            <input type="text" id="obj-input" placeholder="Ej: Mejorar transporte en Wonder City">
            <input type="text" id="kr1-input" placeholder="KR 1 (MÃ©trica)">
            <input type="text" id="kr2-input" placeholder="KR 2 (MÃ©trica)">
            <input type="text" id="kr3-input" placeholder="KR 3 (MÃ©trica)">
            <button class="btn" onclick="saveOKR()">Guardar OKR</button>
        </div>

        <h2>Mis OKRs</h2>
        <div id="list-okr">Cargando tus metas...</div>
    </section>

    <div style="text-align:center; margin-top:40px;">
        <a href="#" class="legal-link">Aviso Legal</a>
        <a href="#" class="legal-link">Privacidad</a>
    </div>
</div>

<script>
   // 1. CONFIGURACIÃ“N (REEMPLAZA ESTOS DATOS)
const SUPABASE_URL = 'https://lddajpesoctuzlhjrpyg.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Ap9YMNrnBaD5Bluj38sWpQ_36j9QWm7';

// CAMBIO AQUÃ: Usamos un nombre distinto para evitar el SyntaxError
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let isRegistering = false;

// 2. FUNCIONES DE INTERFAZ (Deben estar definidas antes de usarse)
window.toggleAuth = function() {
    isRegistering = !isRegistering;
    document.getElementById('auth-title').innerText = isRegistering ? "Crear Cuenta" : "Iniciar SesiÃ³n";
    document.getElementById('btn-auth').innerText = isRegistering ? "Registrarse" : "Entrar";
    document.getElementById('toggle-text').innerText = isRegistering ? "Â¿Ya tienes cuenta? Entra" : "Â¿No tienes cuenta? RegÃ­strate";
};

// 3. FUNCIONES DE AUTENTICACIÃ“N
window.handleAuth = async function() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const btn = document.getElementById('btn-auth');
    
    if(!email || !password) return alert("Completa todos los campos");

    btn.disabled = true;
    btn.innerText = "Procesando...";

    try {
        if (isRegistering) {
            const { error } = await _supabase.auth.signUp({ email, password });
            if (error) throw error;
            alert("Â¡Registro enviado! Revisa tu email para confirmar tu cuenta.");
        } else {
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            checkUser();
        }
    } catch (err) {
        alert("Error: " + err.message);
    } finally {
        btn.disabled = false;
        btn.innerText = isRegistering ? "Registrarse" : "Entrar";
    }
};

window.resetPass = async function() {
    const email = document.getElementById('email').value;
    if (!email) return alert("Escribe tu email primero en el campo de arriba");
    const { error } = await _supabase.auth.resetPasswordForEmail(email);
    alert(error ? error.message : "Email de recuperaciÃ³n enviado. Revisa tu bandeja.");
};

// 4. LOGICA DE NEGOCIO (OKRS)
window.saveOKR = async function() {
    const { data: { user } } = await _supabase.auth.getUser();
    const obj = {
        user_id: user.id,
        objetivo: document.getElementById('obj-input').value,
        kr1: document.getElementById('kr1-input').value,
        kr2: document.getElementById('kr2-input').value,
        kr3: document.getElementById('kr3-input').value
    };

    if(!obj.objetivo) return alert("El objetivo es obligatorio");

    const { error: err } = await _supabase.from('okrs').insert([obj]);

    if (err) {
        alert("Error al guardar: " + err.message);
    } else {
        alert("Â¡OKR Guardado correctamente!");
        loadOKRs();
        // Limpiar campos
        document.getElementById('obj-input').value = "";
        document.getElementById('kr1-input').value = "";
        document.getElementById('kr2-input').value = "";
        document.getElementById('kr3-input').value = "";
    }
};

window.loadOKRs = async function() {
    const container = document.getElementById('list-okr');
    const { data, error } = await _supabase.from('okrs').select('*').order('created_at', { ascending: false });
    
    if (error) {
        console.error(error);
        container.innerHTML = "Error al cargar datos.";
        return;
    }
    
    container.innerHTML = data.length ? "" : "No tienes OKRs registrados aÃºn.";
    
    data.forEach(item => {
        container.innerHTML += `
            <div class="okr-item" style="background:#fff; padding:15px; margin-bottom:10px; border-radius:5px; border-left:5px solid #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1)">
                <strong style="font-size:1.1rem">ðŸŽ¯ ${item.objetivo}</strong>
                <p style="margin:5px 0"><strong>KR1:</strong> ${item.kr1 || '-'}</p>
                <p style="margin:5px 0"><strong>KR2:</strong> ${item.kr2 || '-'}</p>
                <p style="margin:5px 0"><strong>KR3:</strong> ${item.kr3 || '-'}</p>
            </div>
        `;
    });
};

// 5. CONTROL DE SESIÃ“N
window.checkUser = async function() {
    const { data: { session } } = await _supabase.auth.getSession();
    if (session) {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('app-section').classList.remove('hidden');
        document.getElementById('nav-user').classList.remove('hidden');
        loadOKRs();
    }
};

window.logout = async function() {
    await _supabase.auth.signOut();
    window.location.reload();
};

// Ejecutar al cargar la pÃ¡gina
document.addEventListener('DOMContentLoaded', checkUser);
</script>
</body>
</html>