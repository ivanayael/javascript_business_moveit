<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move It OKR Master</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #2563eb; --bg: #f1f5f9; --txt: #0f172a; }
        body { font-family: sans-serif; background: var(--bg); color: var(--txt); margin: 0; padding-bottom: 50px; }
        nav { background: #1e293b; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { background: var(--p); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn:disabled { background: #94a3b8; }
        .hidden { display: none; }
        .okr-item { border-left: 5px solid var(--p); padding-left: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .legal-link { font-size: 0.8rem; color: #64748b; text-decoration: none; margin-right: 10px; }
    </style>
</head>
<body>

<nav>
    <strong>ðŸš€ Move It</strong>
    <div id="nav-user" class="hidden">
        <button onclick="logout()" style="background:none; border:1px solid white; color:white; cursor:pointer; border-radius:4px;">Salir</button>
    </div>
</nav>

<div class="container">
    <section id="auth-section" class="card">
        <h2 id="auth-title">Iniciar SesiÃ³n</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="ContraseÃ±a">
        <button id="btn-auth" class="btn" onclick="handleAuth()">Entrar</button>
        <p style="text-align:center">
            <a href="javascript:void(0)" onclick="toggleAuth()" id="toggle-text">Â¿No tienes cuenta? RegÃ­strate</a>
        </p>
        <p style="text-align:center"><a href="javascript:void(0)" onclick="resetPass()" style="font-size:0.8rem">OlvidÃ© mi contraseÃ±a</a></p>
    </section>

    <section id="app-section" class="hidden">
        <div class="card">
            <h3>+ Nuevo Objetivo Anual</h3>
            <input type="text" id="obj-input" placeholder="Ej: Mejorar transporte en Wonder City">
            <input type="text" id="kr1-input" placeholder="KR 1 (MÃ©trica)">
            <input type="text" id="kr2-input" placeholder="KR 2 (MÃ©trica)">
            <input type="text" id="kr3-input" placeholder="KR 3 (MÃ©trica)">
            <button class="btn" onclick="saveOKR()">Guardar OKR</button>
        </div>

        <h2>Mis OKRs</h2>
        <div id="list-okr">Cargando tus metas...</div>
    </section>

    <div style="text-align:center; margin-top:40px;">
        <a href="#" class="legal-link">Aviso Legal</a>
        <a href="#" class="legal-link">Privacidad</a>
    </div>
</div>

<script>
    // 1. CONFIGURACIÃ“N (REEMPLAZA ESTOS DATOS)
    const SUPABASE_URL = 'https://TU_PROYECTO.supabase.co';
    const SUPABASE_KEY = 'TU_ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isRegistering = false;

    // 2. FUNCIONES DE AUTENTICACIÃ“N
    async function handleAuth() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const btn = document.getElementById('btn-auth');
        
        btn.disabled = true;
        btn.innerText = "Procesando...";

        try {
            if (isRegistering) {
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                alert("Â¡Registro exitoso! Revisa tu email para confirmar.");
            } else {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                checkUser();
            }
        } catch (err) {
            alert("Error: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = isRegistering ? "Registrarse" : "Entrar";
        }
    }

    async function resetPass() {
        const email = document.getElementById('email').value;
        if (!email) return alert("Escribe tu email primero");
        const { error } = await supabase.auth.resetPasswordForEmail(email);
        alert(error ? error.message : "Email de recuperaciÃ³n enviado.");
    }

    // 3. LOGICA DE NEGOCIO (OKRS)
    async function saveOKR() {
        const { data: { user } } = await supabase.auth.getUser();
        const obj = {
            user_id: user.id,
            objetivo: document.getElementById('obj-input').value,
            kr1: document.getElementById('kr1-input').value,
            kr2: document.getElementById('kr2-input').value,
            kr3: document.getElementById('kr3-input').value
        };

        const { error } = await supabase.insert('okrs').values([obj]); // NOTA: En v2 es .insert(obj)
        // CorrecciÃ³n de sintaxis para Supabase JS v2:
        const { error: err } = await supabase.from('okrs').insert([obj]);

        if (err) alert(err.message);
        else {
            alert("OKR Guardado");
            loadOKRs();
            document.querySelectorAll('#app-section input').forEach(i => i.value = "");
        }
    }

    async function loadOKRs() {
        const { data, error } = await supabase.from('okrs').select('*').order('created_at', { ascending: false });
        if (error) return console.error(error);
        
        const container = document.getElementById('list-okr');
        container.innerHTML = data.length ? "" : "No tienes OKRs aÃºn.";
        
        data.forEach(item => {
            container.innerHTML += `
                <div class="okr-item">
                    <strong>ðŸŽ¯ ${item.objetivo}</strong>
                    <p>1. ${item.kr1}</p>
                    <p>2. ${item.kr2}</p>
                    <p>3. ${item.kr3}</p>
                </div>
            `;
        });
    }

    // 4. CONTROL DE FLUJO
    function toggleAuth() {
        isRegistering = !isRegistering;
        document.getElementById('auth-title').innerText = isRegistering ? "Crear Cuenta" : "Iniciar SesiÃ³n";
        document.getElementById('btn-auth').innerText = isRegistering ? "Registrarse" : "Entrar";
        document.getElementById('toggle-text').innerText = isRegistering ? "Â¿Ya tienes cuenta? Entra" : "Â¿No tienes cuenta? RegÃ­strate";
    }

    async function checkUser() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('nav-user').classList.remove('hidden');
            loadOKRs();
        }
    }

    async function logout() {
        await supabase.auth.signOut();
        window.location.reload();
    }

    window.onload = checkUser;
</script>
</body>
</html>